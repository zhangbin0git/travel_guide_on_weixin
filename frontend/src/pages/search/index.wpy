<template>
  <view class="search-page">
    <!-- æœç´¢æ  -->
    <view class="search-container">
      <view class="search-input-wrapper">
        <input 
          class="search-input" 
          v-model="searchKeyword" 
          placeholder="æœç´¢ç›®çš„åœ°ã€æ”»ç•¥ã€æ™¯ç‚¹"
          confirm-type="search"
          @confirm="onSearch"
          @input="onInput"
        />
        <view class="search-clear" v-if="searchKeyword" @tap="clearSearch">
          <text class="clear-icon">Ã—</text>
        </view>
      </view>
      <view class="search-cancel" @tap="goBack">å–æ¶ˆ</view>
    </view>
    
    <!-- æœç´¢å†å² -->
    <view class="history-container" v-if="!searchKeyword && searchHistory.length">
      <view class="history-header">
        <text class="history-title">æœç´¢å†å²</text>
        <text class="history-clear" @tap="clearHistory">æ¸…ç©º</text>
      </view>
      <view class="history-list">
        <view 
          class="history-item" 
          v-for="(item, index) in searchHistory" 
          :key="index"
          @tap="onHistoryTap(item)"
        >
          <text class="history-text">{{ item }}</text>
        </view>
      </view>
    </view>
    
    <!-- çƒ­é—¨æœç´¢ -->
    <view class="hot-container" v-if="!searchKeyword">
      <view class="hot-header">
        <text class="hot-title">çƒ­é—¨æœç´¢</text>
      </view>
      <view class="hot-list">
        <view 
          class="hot-item" 
          v-for="(item, index) in hotSearchList" 
          :key="index"
          @tap="onHotTap(item)"
        >
          <text class="hot-text">{{ item }}</text>
        </view>
      </view>
    </view>
    
    <!-- æœç´¢ç»“æœ -->
    <view class="result-container" v-if="searchKeyword">
      <!-- åˆ†ç±»åˆ‡æ¢ -->
      <view class="tab-container">
        <view 
          class="tab-item" 
          v-for="(tab, index) in tabList" 
          :key="index"
          :class="{ active: currentTab === index }"
          @tap="switchTab(index)"
        >
          <text class="tab-text">{{ tab.name }}</text>
        </view>
      </view>
      
      <!-- æ”»ç•¥ç»“æœ -->
      <view class="guide-result" v-if="currentTab === 0">
        <view 
          class="guide-item" 
          v-for="(item, index) in guideResults" 
          :key="index"
          @tap="goToGuideDetail(item.id)"
        >
          <image 
            class="guide-image" 
            :src="item.coverImage" 
            mode="aspectFill"
          />
          <view class="guide-content">
            <text class="guide-title">{{ item.title }}</text>
            <text class="guide-desc">{{ item.description }}</text>
            <view class="guide-meta">
              <text class="guide-destination">{{ item.destination }}</text>
              <text class="guide-days">{{ item.days }}å¤©</text>
            </view>
          </view>
        </view>
        <view class="no-result" v-if="!guideResults.length && !loading">
          <text class="no-result-text">æš‚æ— ç›¸å…³æ”»ç•¥</text>
        </view>
        <view class="loading" v-if="loading">
          <text class="loading-text">åŠ è½½ä¸­...</text>
        </view>
      </view>
      
      <!-- ç›®çš„åœ°ç»“æœ -->
      <view class="destination-result" v-if="currentTab === 1">
        <view 
          class="destination-item" 
          v-for="(item, index) in destinationResults" 
          :key="index"
          @tap="goToDestinationDetail(item.id)"
        >
          <image 
            class="destination-image" 
            :src="item.coverImage" 
            mode="aspectFill"
          />
          <view class="destination-content">
            <text class="destination-name">{{ item.name }}</text>
            <text class="destination-desc">{{ item.description }}</text>
            <view class="destination-meta">
              <text class="destination-count">{{ item.guideCount }}ä¸ªæ”»ç•¥</text>
              <text class="destination-rating">â­ {{ item.rating }}</text>
            </view>
          </view>
        </view>
        <view class="no-result" v-if="!destinationResults.length && !loading">
          <text class="no-result-text">æš‚æ— ç›¸å…³ç›®çš„åœ°</text>
        </view>
        <view class="loading" v-if="loading">
          <text class="loading-text">åŠ è½½ä¸­...</text>
        </view>
      </view>
      
      <!-- æ™¯ç‚¹ç»“æœ -->
      <view class="attraction-result" v-if="currentTab === 2">
        <view 
          class="attraction-item" 
          v-for="(item, index) in attractionResults" 
          :key="index"
          @tap="goToAttractionDetail(item.id)"
        >
          <image 
            class="attraction-image" 
            :src="item.coverImage" 
            mode="aspectFill"
          />
          <view class="attraction-content">
            <text class="attraction-name">{{ item.name }}</text>
            <text class="attraction-desc">{{ item.description }}</text>
            <view class="attraction-meta">
              <text class="attraction-location">ğŸ“ {{ item.location }}</text>
              <text class="attraction-rating">â­ {{ item.rating }}</text>
            </view>
          </view>
        </view>
        <view class="no-result" v-if="!attractionResults.length && !loading">
          <text class="no-result-text">æš‚æ— ç›¸å…³æ™¯ç‚¹</text>
        </view>
        <view class="loading" v-if="loading">
          <text class="loading-text">åŠ è½½ä¸­...</text>
        </view>
      </view>
    </view>
  </view>
</template>

<script lang="ts">
import wepy from '@wepy/core';

wepy.page({
  data: {
    searchKeyword: '',
    currentTab: 0,
    loading: false,
    searchHistory: [
      'åŒ—äº¬',
      'ä¸Šæµ·',
      'æˆéƒ½',
      'è¥¿å®‰',
      'æ­å·'
    ],
    hotSearchList: [
      'äº”ä¸€å»å“ªç©',
      'äº²å­æ¸¸',
      'ç¾é£Ÿæ”»ç•¥',
      'å¤é•‡æ¸¸',
      'æµ·å²›åº¦å‡',
      'è‡ªé©¾æ¸¸',
      'æ‘„å½±åœ£åœ°',
      'ç½‘çº¢æ‰“å¡åœ°'
    ],
    tabList: [
      { id: 0, name: 'æ”»ç•¥' },
      { id: 1, name: 'ç›®çš„åœ°' },
      { id: 2, name: 'æ™¯ç‚¹' }
    ],
    guideResults: [],
    destinationResults: [],
    attractionResults: []
  },
  
  onLoad() {
    // åŠ è½½æœç´¢å†å²
    this.loadSearchHistory();
  },
  
  methods: {
    /**
     * åŠ è½½æœç´¢å†å²
     */
    loadSearchHistory() {
      try {
        const history = wx.getStorageSync('searchHistory');
        if (history) {
          this.searchHistory = JSON.parse(history);
        }
      } catch (error) {
        console.error('åŠ è½½æœç´¢å†å²å¤±è´¥:', error);
      }
    },
    
    /**
     * ä¿å­˜æœç´¢å†å²
     */
    saveSearchHistory(keyword: string) {
      try {
        let history = this.searchHistory.filter(item => item !== keyword);
        history.unshift(keyword);
        history = history.slice(0, 10); // æœ€å¤šä¿å­˜10æ¡
        this.searchHistory = history;
        wx.setStorageSync('searchHistory', JSON.stringify(history));
      } catch (error) {
        console.error('ä¿å­˜æœç´¢å†å²å¤±è´¥:', error);
      }
    },
    
    /**
     * è¾“å…¥äº‹ä»¶
     */
    onInput(e: any) {
      this.searchKeyword = e.detail.value;
      if (this.searchKeyword) {
        // å¯ä»¥åœ¨è¿™é‡Œå®ç°å®æ—¶æœç´¢å»ºè®®
      }
    },
    
    /**
     * æœç´¢
     */
    onSearch() {
      if (!this.searchKeyword.trim()) {
        return;
      }
      
      this.saveSearchHistory(this.searchKeyword);
      this.searchData();
    },
    
    /**
     * æœç´¢æ•°æ®
     */
    async searchData() {
      if (this.loading) {
        return;
      }
      
      this.loading = true;
      
      try {
        // æ ¹æ®å½“å‰é€‰ä¸­çš„æ ‡ç­¾é¡µæœç´¢ä¸åŒç±»å‹çš„æ•°æ®
        switch (this.currentTab) {
          case 0: // æ”»ç•¥
            await this.searchGuides();
            break;
          case 1: // ç›®çš„åœ°
            await this.searchDestinations();
            break;
          case 2: // æ™¯ç‚¹
            await this.searchAttractions();
            break;
        }
      } catch (error) {
        console.error('æœç´¢å¤±è´¥:', error);
        wx.showToast({
          title: 'æœç´¢å¤±è´¥',
          icon: 'none'
        });
      } finally {
        this.loading = false;
      }
    },
    
    /**
     * æœç´¢æ”»ç•¥
     */
    async searchGuides() {
      // è¿™é‡Œå¯ä»¥è°ƒç”¨APIæœç´¢æ”»ç•¥
      // const res = await api.searchGuides(this.searchKeyword);
      // this.guideResults = res.data;
      
      // æ¨¡æ‹Ÿæ•°æ®
      this.guideResults = [
        {
          id: 1,
          title: `${this.searchKeyword}ä¸‰æ—¥æ¸¸å®Œç¾æ”»ç•¥`,
          description: `æ¢ç´¢${this.searchKeyword}çš„å¿…å»æ™¯ç‚¹å’Œç¾é£Ÿ`,
          coverImage: 'https://picsum.photos/seed/guide1/200/150.jpg',
          destination: this.searchKeyword,
          days: 3
        },
        {
          id: 2,
          title: `${this.searchKeyword}å‘¨æœ«æ¸¸æŒ‡å—`,
          description: `${this.searchKeyword}ä¸¤æ—¥æ¸¸ç²¾åè·¯çº¿`,
          coverImage: 'https://picsum.photos/seed/guide2/200/150.jpg',
          destination: this.searchKeyword,
          days: 2
        }
      ];
    },
    
    /**
     * æœç´¢ç›®çš„åœ°
     */
    async searchDestinations() {
      // è¿™é‡Œå¯ä»¥è°ƒç”¨APIæœç´¢ç›®çš„åœ°
      // const res = await api.searchDestinations(this.searchKeyword);
      // this.destinationResults = res.data;
      
      // æ¨¡æ‹Ÿæ•°æ®
      this.destinationResults = [
        {
          id: 1,
          name: this.searchKeyword,
          description: 'çƒ­é—¨æ—…æ¸¸ç›®çš„åœ°',
          coverImage: 'https://picsum.photos/seed/dest1/200/150.jpg',
          guideCount: 25,
          rating: 4.8
        }
      ];
    },
    
    /**
     * æœç´¢æ™¯ç‚¹
     */
    async searchAttractions() {
      // è¿™é‡Œå¯ä»¥è°ƒç”¨APIæœç´¢æ™¯ç‚¹
      // const res = await api.searchAttractions(this.searchKeyword);
      // this.attractionResults = res.data;
      
      // æ¨¡æ‹Ÿæ•°æ®
      this.attractionResults = [
        {
          id: 1,
          name: `${this.searchKeyword}æ™¯ç‚¹`,
          description: 'å¿…å»æ™¯ç‚¹æ¨è',
          coverImage: 'https://picsum.photos/seed/attraction1/200/150.jpg',
          location: this.searchKeyword,
          rating: 4.7
        }
      ];
    },
    
    /**
     * æ¸…ç©ºæœç´¢
     */
    clearSearch() {
      this.searchKeyword = '';
      this.guideResults = [];
      this.destinationResults = [];
      this.attractionResults = [];
    },
    
    /**
     * æ¸…ç©ºå†å²
     */
    clearHistory() {
      this.searchHistory = [];
      wx.removeStorageSync('searchHistory');
    },
    
    /**
     * å†å²è®°å½•ç‚¹å‡»
     */
    onHistoryTap(keyword: string) {
      this.searchKeyword = keyword;
      this.onSearch();
    },
    
    /**
     * çƒ­é—¨æœç´¢ç‚¹å‡»
     */
    onHotTap(keyword: string) {
      this.searchKeyword = keyword;
      this.onSearch();
    },
    
    /**
     * åˆ‡æ¢æ ‡ç­¾é¡µ
     */
    switchTab(index: number) {
      if (this.currentTab === index) {
        return;
      }
      
      this.currentTab = index;
      if (this.searchKeyword) {
        this.searchData();
      }
    },
    
    /**
     * è¿”å›ä¸Šä¸€é¡µ
     */
    goBack() {
      wx.navigateBack();
    },
    
    /**
     * è·³è½¬åˆ°æ”»ç•¥è¯¦æƒ…
     */
    goToGuideDetail(id: number) {
      wx.navigateTo({
        url: `/pages/guide-detail/index?id=${id}`
      });
    },
    
    /**
     * è·³è½¬åˆ°ç›®çš„åœ°è¯¦æƒ…
     */
    goToDestinationDetail(id: number) {
      wx.navigateTo({
        url: `/pages/destination-detail/index?id=${id}`
      });
    },
    
    /**
     * è·³è½¬åˆ°æ™¯ç‚¹è¯¦æƒ…
     */
    goToAttractionDetail(id: number) {
      wx.navigateTo({
        url: `/pages/attraction-detail/index?id=${id}`
      });
    }
  }
});
</script>

<style lang="scss" src="@/assets/styles/index.scss" />

<style lang="scss">
.search-page {
  min-height: 100vh;
  background-color: #f5f5f5;
}

.search-container {
  display: flex;
  align-items: center;
  padding: 20rpx;
  background-color: #ffffff;
  
  .search-input-wrapper {
    flex: 1;
    position: relative;
    
    .search-input {
      height: 72rpx;
      padding: 0 80rpx 0 24rpx;
      background-color: #f5f5f5;
      border-radius: 36rpx;
      font-size: 28rpx;
    }
    
    .search-clear {
      position: absolute;
      right: 20rpx;
      top: 50%;
      transform: translateY(-50%);
      width: 40rpx;
      height: 40rpx;
      line-height: 40rpx;
      text-align: center;
      background-color: #ccc;
      border-radius: 50%;
      
      .clear-icon {
        font-size: 24rpx;
        color: #fff;
      }
    }
  }
  
  .search-cancel {
    margin-left: 20rpx;
    font-size: 28rpx;
    color: #007aff;
  }
}

.history-container, .hot-container {
  margin-top: 20rpx;
  padding: 30rpx;
  background-color: #ffffff;
  
  .history-header, .hot-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20rpx;
    
    .history-title, .hot-title {
      font-size: 28rpx;
      font-weight: bold;
      color: #333;
    }
    
    .history-clear {
      font-size: 24rpx;
      color: #999;
    }
  }
  
  .history-list, .hot-list {
    display: flex;
    flex-wrap: wrap;
    
    .history-item, .hot-item {
      margin-right: 20rpx;
      margin-bottom: 20rpx;
      padding: 10rpx 20rpx;
      background-color: #f5f5f5;
      border-radius: 30rpx;
      
      .history-text, .hot-text {
        font-size: 24rpx;
        color: #333;
      }
    }
    
    .hot-item {
      background-color: rgba(0, 122, 255, 0.1);
      
      .hot-text {
        color: #007aff;
      }
    }
  }
}

.result-container {
  margin-top: 20rpx;
  background-color: #ffffff;
}

.tab-container {
  display: flex;
  border-bottom: 1rpx solid #eee;
  
  .tab-item {
    flex: 1;
    height: 80rpx;
    line-height: 80rpx;
    text-align: center;
    
    &.active {
      position: relative;
      
      .tab-text {
        color: #007aff;
        font-weight: bold;
      }
      
      &::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 60rpx;
        height: 4rpx;
        background-color: #007aff;
        border-radius: 2rpx;
      }
    }
    
    .tab-text {
      font-size: 28rpx;
      color: #666;
    }
  }
}

.guide-result, .destination-result, .attraction-result {
  padding: 20rpx;
  
  .guide-item, .destination-item, .attraction-item {
    display: flex;
    padding: 20rpx;
    margin-bottom: 20rpx;
    background-color: #ffffff;
    border-radius: 16rpx;
    box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.1);
    
    .guide-image, .destination-image, .attraction-image {
      width: 200rpx;
      height: 150rpx;
      margin-right: 20rpx;
      border-radius: 12rpx;
    }
    
    .guide-content, .destination-content, .attraction-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      
      .guide-title, .destination-name, .attraction-name {
        font-size: 28rpx;
        font-weight: bold;
        color: #333;
        margin-bottom: 8rpx;
      }
      
      .guide-desc, .destination-desc, .attraction-desc {
        font-size: 24rpx;
        color: #666;
        margin-bottom: 16rpx;
      }
      
      .guide-meta, .destination-meta, .attraction-meta {
        display: flex;
        justify-content: space-between;
        
        .guide-destination, .guide-days, .destination-count, .attraction-location {
          font-size: 24rpx;
          color: #007aff;
        }
        
        .destination-rating, .attraction-rating {
          font-size: 24rpx;
          color: #ff9500;
        }
      }
    }
  }
}

.no-result {
  padding: 100rpx 0;
  text-align: center;
  
  .no-result-text {
    font-size: 28rpx;
    color: #999;
  }
}

.loading {
  padding: 50rpx 0;
  text-align: center;
  
  .loading-text {
    font-size: 28rpx;
    color: #999;
  }
}
</style>