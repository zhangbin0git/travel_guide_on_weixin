<template>
  <view class="user-page">
    <!-- ç”¨æˆ·ä¿¡æ¯ -->
    <view class="user-header">
      <view class="user-avatar" @tap="goToProfile">
        <image 
          class="avatar-image" 
          :src="userInfo.avatarUrl || '/assets/images/default-avatar.png'" 
          mode="aspectFill"
        />
      </view>
      <view class="user-info" @tap="goToProfile">
        <text class="user-name" v-if="userInfo.nickName">{{ userInfo.nickName }}</text>
        <text class="user-name" v-else>ç‚¹å‡»ç™»å½•</text>
        <text class="user-desc" v-if="userInfo.nickName">{{ userInfo.signature || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡ç•™ä¸‹' }}</text>
      </view>
      <view class="user-setting" @tap="goToSettings">
        <text class="setting-icon">âš™ï¸</text>
      </view>
    </view>
    
    <!-- ç”¨æˆ·ç»Ÿè®¡ -->
    <view class="stats-container" v-if="userInfo.nickName">
      <view class="stats-item" @tap="goToMyGuides">
        <text class="stats-number">{{ userInfo.guideCount || 0 }}</text>
        <text class="stats-label">æ”»ç•¥</text>
      </view>
      <view class="stats-item" @tap="goToMyFavorites">
        <text class="stats-number">{{ userInfo.favoriteCount || 0 }}</text>
        <text class="stats-label">æ”¶è—</text>
      </view>
      <view class="stats-item" @tap="goToMyPlans">
        <text class="stats-number">{{ userInfo.planCount || 0 }}</text>
        <text class="stats-label">è®¡åˆ’</text>
      </view>
      <view class="stats-item" @tap="goToMyFootprints">
        <text class="stats-number">{{ userInfo.footprintCount || 0 }}</text>
        <text class="stats-label">è¶³è¿¹</text>
      </view>
    </view>
    
    <!-- ç™»å½•æç¤º -->
    <view class="login-tip" v-else @tap="goToLogin">
      <text class="login-text">ç™»å½•åæŸ¥çœ‹æ›´å¤šå†…å®¹</text>
      <text class="login-btn">ç«‹å³ç™»å½•</text>
    </view>
    
    <!-- åŠŸèƒ½èœå• -->
    <view class="menu-container">
      <view class="menu-group">
        <view class="menu-item" @tap="goToMyGuides">
          <view class="menu-left">
            <text class="menu-icon">ğŸ“</text>
            <text class="menu-title">æˆ‘çš„æ”»ç•¥</text>
          </view>
          <view class="menu-right">
            <text class="menu-count">{{ userInfo.guideCount || 0 }}</text>
            <text class="menu-arrow">></text>
          </view>
        </view>
        <view class="menu-item" @tap="goToMyFavorites">
          <view class="menu-left">
            <text class="menu-icon">â¤ï¸</text>
            <text class="menu-title">æˆ‘çš„æ”¶è—</text>
          </view>
          <view class="menu-right">
            <text class="menu-count">{{ userInfo.favoriteCount || 0 }}</text>
            <text class="menu-arrow">></text>
          </view>
        </view>
        <view class="menu-item" @tap="goToMyPlans">
          <view class="menu-left">
            <text class="menu-icon">ğŸ“…</text>
            <text class="menu-title">æˆ‘çš„è®¡åˆ’</text>
          </view>
          <view class="menu-right">
            <text class="menu-count">{{ userInfo.planCount || 0 }}</text>
            <text class="menu-arrow">></text>
          </view>
        </view>
        <view class="menu-item" @tap="goToMyFootprints">
          <view class="menu-left">
            <text class="menu-icon">ğŸ‘£</text>
            <text class="menu-title">æˆ‘çš„è¶³è¿¹</text>
          </view>
          <view class="menu-right">
            <text class="menu-count">{{ userInfo.footprintCount || 0 }}</text>
            <text class="menu-arrow">></text>
          </view>
        </view>
      </view>
      
      <view class="menu-group">
        <view class="menu-item" @tap="goToHistory">
          <view class="menu-left">
            <text class="menu-icon">ğŸ•</text>
            <text class="menu-title">æµè§ˆå†å²</text>
          </view>
          <view class="menu-right">
            <text class="menu-arrow">></text>
          </view>
        </view>
        <view class="menu-item" @tap="goToOffline">
          <view class="menu-left">
            <text class="menu-icon">ğŸ’¾</text>
            <text class="menu-title">ç¦»çº¿ä¸‹è½½</text>
          </view>
          <view class="menu-right">
            <text class="menu-arrow">></text>
          </view>
        </view>
      </view>
      
      <view class="menu-group">
        <view class="menu-item" @tap="goToFeedback">
          <view class="menu-left">
            <text class="menu-icon">ğŸ’¬</text>
            <text class="menu-title">æ„è§åé¦ˆ</text>
          </view>
          <view class="menu-right">
            <text class="menu-arrow">></text>
          </view>
        </view>
        <view class="menu-item" @tap="goToAbout">
          <view class="menu-left">
            <text class="menu-icon">â„¹ï¸</text>
            <text class="menu-title">å…³äºæˆ‘ä»¬</text>
          </view>
          <view class="menu-right">
            <text class="menu-arrow">></text>
          </view>
        </view>
      </view>
    </view>
  </view>
</template>

<script lang="ts">
import wepy from '@wepy/core';

wepy.page({
  data: {
    userInfo: {
      nickName: '',
      avatarUrl: '',
      signature: '',
      guideCount: 0,
      favoriteCount: 0,
      planCount: 0,
      footprintCount: 0
    },
    hasLogin: false
  },
  
  onLoad() {
    this.checkLoginStatus();
  },
  
  onShow() {
    // æ¯æ¬¡é¡µé¢æ˜¾ç¤ºæ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
    this.checkLoginStatus();
  },
  
  methods: {
    /**
     * æ£€æŸ¥ç™»å½•çŠ¶æ€
     */
    checkLoginStatus() {
      try {
        const userInfo = wx.getStorageSync('userInfo');
        if (userInfo) {
          this.userInfo = JSON.parse(userInfo);
          this.hasLogin = true;
        } else {
          this.hasLogin = false;
        }
      } catch (error) {
        console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
        this.hasLogin = false;
      }
    },
    
    /**
     * è·³è½¬åˆ°ç™»å½•é¡µ
     */
    goToLogin() {
      wx.navigateTo({
        url: '/pages/login/index'
      });
    },
    
    /**
     * è·³è½¬åˆ°ä¸ªäººèµ„æ–™é¡µ
     */
    goToProfile() {
      if (!this.hasLogin) {
        this.goToLogin();
        return;
      }
      
      wx.navigateTo({
        url: '/pages/profile/index'
      });
    },
    
    /**
     * è·³è½¬åˆ°è®¾ç½®é¡µ
     */
    goToSettings() {
      wx.navigateTo({
        url: '/pages/settings/index'
      });
    },
    
    /**
     * è·³è½¬åˆ°æˆ‘çš„æ”»ç•¥
     */
    goToMyGuides() {
      if (!this.hasLogin) {
        this.goToLogin();
        return;
      }
      
      wx.navigateTo({
        url: '/pages/my-guides/index'
      });
    },
    
    /**
     * è·³è½¬åˆ°æˆ‘çš„æ”¶è—
     */
    goToMyFavorites() {
      if (!this.hasLogin) {
        this.goToLogin();
        return;
      }
      
      wx.navigateTo({
        url: '/pages/my-favorites/index'
      });
    },
    
    /**
     * è·³è½¬åˆ°æˆ‘çš„è®¡åˆ’
     */
    goToMyPlans() {
      if (!this.hasLogin) {
        this.goToLogin();
        return;
      }
      
      wx.navigateTo({
        url: '/pages/my-plans/index'
      });
    },
    
    /**
     * è·³è½¬åˆ°æˆ‘çš„è¶³è¿¹
     */
    goToMyFootprints() {
      if (!this.hasLogin) {
        this.goToLogin();
        return;
      }
      
      wx.navigateTo({
        url: '/pages/my-footprints/index'
      });
    },
    
    /**
     * è·³è½¬åˆ°æµè§ˆå†å²
     */
    goToHistory() {
      wx.navigateTo({
        url: '/pages/history/index'
      });
    },
    
    /**
     * è·³è½¬åˆ°ç¦»çº¿ä¸‹è½½
     */
    goToOffline() {
      wx.navigateTo({
        url: '/pages/offline/index'
      });
    },
    
    /**
     * è·³è½¬åˆ°æ„è§åé¦ˆ
     */
    goToFeedback() {
      wx.navigateTo({
        url: '/pages/feedback/index'
      });
    },
    
    /**
     * è·³è½¬åˆ°å…³äºæˆ‘ä»¬
     */
    goToAbout() {
      wx.navigateTo({
        url: '/pages/about/index'
      });
    }
  }
});
</script>

<style lang="scss" src="@/assets/styles/index.scss" />

<style lang="scss">
.user-page {
  min-height: 100vh;
  background-color: #f5f5f5;
}

.user-header {
  display: flex;
  align-items: center;
  padding: 40rpx 30rpx;
  background-color: #ffffff;
  
  .user-avatar {
    width: 120rpx;
    height: 120rpx;
    margin-right: 30rpx;
    
    .avatar-image {
      width: 100%;
      height: 100%;
      border-radius: 60rpx;
    }
  }
  
  .user-info {
    flex: 1;
    
    .user-name {
      display: block;
      font-size: 32rpx;
      font-weight: bold;
      color: #333;
      margin-bottom: 10rpx;
    }
    
    .user-desc {
      font-size: 24rpx;
      color: #999;
    }
  }
  
  .user-setting {
    .setting-icon {
      font-size: 40rpx;
    }
  }
}

.stats-container {
  display: flex;
  padding: 30rpx 0;
  background-color: #ffffff;
  border-top: 1rpx solid #f5f5f5;
  
  .stats-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    
    .stats-number {
      font-size: 36rpx;
      font-weight: bold;
      color: #333;
      margin-bottom: 10rpx;
    }
    
    .stats-label {
      font-size: 24rpx;
      color: #666;
    }
  }
}

.login-tip {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 30rpx;
  background-color: #ffffff;
  border-top: 1rpx solid #f5f5f5;
  
  .login-text {
    font-size: 28rpx;
    color: #666;
  }
  
  .login-btn {
    padding: 10rpx 30rpx;
    font-size: 24rpx;
    color: #007aff;
    background-color: rgba(0, 122, 255, 0.1);
    border-radius: 30rpx;
  }
}

.menu-container {
  margin-top: 20rpx;
}

.menu-group {
  margin-bottom: 20rpx;
  background-color: #ffffff;
  
  .menu-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 30rpx;
    border-bottom: 1rpx solid #f5f5f5;
    
    &:last-child {
      border-bottom: none;
    }
    
    .menu-left {
      display: flex;
      align-items: center;
      
      .menu-icon {
        width: 40rpx;
        height: 40rpx;
        margin-right: 20rpx;
        font-size: 32rpx;
      }
      
      .menu-title {
        font-size: 28rpx;
        color: #333;
      }
    }
    
    .menu-right {
      display: flex;
      align-items: center;
      
      .menu-count {
        margin-right: 10rpx;
        font-size: 24rpx;
        color: #999;
      }
      
      .menu-arrow {
        font-size: 24rpx;
        color: #ccc;
      }
    }
  }
}
</style>