<template>
  <view class="guide-detail-page">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <view class="nav-bar">
      <view class="nav-left" @tap="goBack">
        <text class="nav-icon">â†</text>
      </view>
      <view class="nav-title">æ”»ç•¥è¯¦æƒ…</view>
      <view class="nav-right">
        <text class="nav-icon" @tap="toggleFavorite">{{ isFavorite ? 'â¤ï¸' : 'ğŸ¤' }}</text>
        <text class="nav-icon" @tap="shareGuide">ğŸ“¤</text>
      </view>
    </view>
    
    <!-- æ”»ç•¥å†…å®¹ -->
    <scroll-view 
      class="content-container" 
      scroll-y 
      :scroll-top="scrollTop"
      @scroll="onScroll"
    >
      <!-- å°é¢å›¾ -->
      <view class="cover-container">
        <image 
          class="cover-image" 
          :src="guideData.coverImage" 
          mode="aspectFill"
        />
        <view class="cover-overlay">
          <text class="cover-title">{{ guideData.title }}</text>
          <view class="cover-meta">
            <text class="cover-destination">{{ guideData.destination }}</text>
            <text class="cover-days">{{ guideData.days }}å¤©</text>
          </view>
        </view>
      </view>
      
      <!-- æ”»ç•¥ä¿¡æ¯ -->
      <view class="info-container">
        <view class="info-item">
          <text class="info-label">ä½œè€…</text>
          <text class="info-value">{{ guideData.author }}</text>
        </view>
        <view class="info-item">
          <text class="info-label">å‘å¸ƒæ—¶é—´</text>
          <text class="info-value">{{ guideData.publishTime }}</text>
        </view>
        <view class="info-item">
          <text class="info-label">æµè§ˆé‡</text>
          <text class="info-value">{{ guideData.viewCount }}æ¬¡</text>
        </view>
        <view class="info-item">
          <text class="info-label">æ”¶è—é‡</text>
          <text class="info-value">{{ guideData.favoriteCount }}æ¬¡</text>
        </view>
      </view>
      
      <!-- è¡Œç¨‹æ¦‚è§ˆ -->
      <view class="section-container">
        <view class="section-title">è¡Œç¨‹æ¦‚è§ˆ</view>
        <view class="timeline-container">
          <view 
            class="timeline-item" 
            v-for="(day, index) in guideData.itinerary" 
            :key="index"
          >
            <view class="timeline-dot"></view>
            <view class="timeline-content">
              <view class="timeline-day">ç¬¬{{ index + 1 }}å¤©</view>
              <view class="timeline-title">{{ day.title }}</view>
              <view class="timeline-desc">{{ day.description }}</view>
              <view class="timeline-places">
                <text 
                  class="place-tag" 
                  v-for="(place, placeIndex) in day.places" 
                  :key="placeIndex"
                >{{ place }}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- è¯¦ç»†è¡Œç¨‹ -->
      <view class="section-container">
        <view class="section-title">è¯¦ç»†è¡Œç¨‹</view>
        <view 
          class="day-container" 
          v-for="(day, index) in guideData.itinerary" 
          :key="index"
        >
          <view class="day-header">
            <text class="day-title">ç¬¬{{ index + 1 }}å¤©ï¼š{{ day.title }}</text>
          </view>
          <view 
            class="activity-item" 
            v-for="(activity, actIndex) in day.activities" 
            :key="actIndex"
          >
            <view class="activity-time">{{ activity.time }}</view>
            <view class="activity-content">
              <view class="activity-title">{{ activity.title }}</view>
              <view class="activity-desc">{{ activity.description }}</view>
              <view class="activity-images" v-if="activity.images && activity.images.length">
                <image 
                  class="activity-image" 
                  v-for="(img, imgIndex) in activity.images" 
                  :key="imgIndex"
                  :src="img" 
                  mode="aspectFill"
                  @tap="previewImage(activity.images, imgIndex)"
                />
              </view>
              <view class="activity-tips" v-if="activity.tips">
                <text class="tips-label">ğŸ’¡ å°è´´å£«ï¼š</text>
                <text class="tips-content">{{ activity.tips }}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- è´¹ç”¨é¢„ç®— -->
      <view class="section-container">
        <view class="section-title">è´¹ç”¨é¢„ç®—</view>
        <view class="budget-container">
          <view class="budget-item">
            <text class="budget-label">äº¤é€š</text>
            <text class="budget-value">Â¥{{ guideData.budget.transportation }}</text>
          </view>
          <view class="budget-item">
            <text class="budget-label">ä½å®¿</text>
            <text class="budget-value">Â¥{{ guideData.budget.accommodation }}</text>
          </view>
          <view class="budget-item">
            <text class="budget-label">é¤é¥®</text>
            <text class="budget-value">Â¥{{ guideData.budget.food }}</text>
          </view>
          <view class="budget-item">
            <text class="budget-label">é—¨ç¥¨</text>
            <text class="budget-value">Â¥{{ guideData.budget.tickets }}</text>
          </view>
          <view class="budget-item total">
            <text class="budget-label">æ€»è®¡</text>
            <text class="budget-value">Â¥{{ guideData.budget.total }}</text>
          </view>
        </view>
      </view>
      
      <!-- æ³¨æ„äº‹é¡¹ -->
      <view class="section-container">
        <view class="section-title">æ³¨æ„äº‹é¡¹</view>
        <view class="notice-container">
          <view 
            class="notice-item" 
            v-for="(notice, index) in guideData.notices" 
            :key="index"
          >
            <text class="notice-icon">âš ï¸</text>
            <text class="notice-text">{{ notice }}</text>
          </view>
        </view>
      </view>
      
      <!-- åº•éƒ¨å ä½ -->
      <view class="bottom-placeholder"></view>
    </scroll-view>
    
    <!-- åº•éƒ¨æ“ä½œæ  -->
    <view class="bottom-bar">
      <view class="action-item" @tap="toggleFavorite">
        <text class="action-icon">{{ isFavorite ? 'â¤ï¸' : 'ğŸ¤' }}</text>
        <text class="action-text">æ”¶è—</text>
      </view>
      <view class="action-item" @tap="shareGuide">
        <text class="action-icon">ğŸ“¤</text>
        <text class="action-text">åˆ†äº«</text>
      </view>
      <view class="action-item" @tap="generatePlan">
        <text class="action-icon">ğŸ“…</text>
        <text class="action-text">ç”Ÿæˆè®¡åˆ’</text>
      </view>
      <view class="action-button" @tap="startNavigation">
        <text class="button-text">å¼€å§‹å¯¼èˆª</text>
      </view>
    </view>
  </view>
</template>

<script lang="ts">
import wepy from '@wepy/core';

wepy.page({
  data: {
    guideId: 0,
    scrollTop: 0,
    isFavorite: false,
    guideData: {
      id: 1,
      title: 'åŒ—äº¬ä¸‰æ—¥æ¸¸å®Œç¾æ”»ç•¥',
      coverImage: 'https://picsum.photos/seed/guide-detail/750/400.jpg',
      destination: 'åŒ—äº¬',
      days: 3,
      author: 'æ—…è¡Œè¾¾äºº',
      publishTime: '2023-05-15',
      viewCount: 12850,
      favoriteCount: 856,
      itinerary: [
        {
          title: 'æ•…å®«-å¤©å®‰é—¨å¹¿åœº',
          description: 'æ¸¸è§ˆçš‡å®¶å®«æ®¿ï¼Œæ„Ÿå—å†å²æ–‡åŒ–',
          places: ['æ•…å®«', 'å¤©å®‰é—¨å¹¿åœº', 'å›½å®¶åšç‰©é¦†'],
          activities: [
            {
              time: '09:00',
              title: 'å¤©å®‰é—¨å¹¿åœº',
              description: 'è§‚çœ‹å‡æ——ä»ªå¼ï¼Œå‚è§‚äººæ°‘è‹±é›„çºªå¿µç¢‘',
              images: ['https://picsum.photos/seed/tiananmen1/300/200.jpg', 'https://picsum.photos/seed/tiananmen2/300/200.jpg'],
              tips: 'å‡æ——ä»ªå¼æ—¶é—´éšæ—¥å‡ºæ—¶é—´å˜åŒ–ï¼Œå»ºè®®æå‰æŸ¥è¯¢'
            },
            {
              time: '10:30',
              title: 'æ•…å®«åšç‰©é™¢',
              description: 'æ¸¸è§ˆå¤ªå’Œæ®¿ã€ä¹¾æ¸…å®«ç­‰ä¸»è¦å®«æ®¿',
              images: ['https://picsum.photos/seed/gugong1/300/200.jpg', 'https://picsum.photos/seed/gugong2/300/200.jpg'],
              tips: 'å»ºè®®æå‰ç½‘ä¸Šé¢„çº¦é—¨ç¥¨ï¼Œé¿å…ç°åœºæ’é˜Ÿ'
            },
            {
              time: '14:00',
              title: 'å›½å®¶åšç‰©é¦†',
              description: 'å‚è§‚å¤ä»£ä¸­å›½é™ˆåˆ—å±•',
              images: ['https://picsum.photos/seed/museum1/300/200.jpg'],
              tips: 'å‘¨ä¸€é—­é¦†ï¼Œæ³¨æ„å¼€æ”¾æ—¶é—´'
            }
          ]
        },
        {
          title: 'é•¿åŸ-æ˜åä¸‰é™µ',
          description: 'ç™»é•¿åŸåšå¥½æ±‰ï¼Œæ¢è®¿æ˜ä»£çš‡é™µ',
          places: ['å…«è¾¾å²­é•¿åŸ', 'æ˜åä¸‰é™µ'],
          activities: [
            {
              time: '08:00',
              title: 'å…«è¾¾å²­é•¿åŸ',
              description: 'ç™»é•¿åŸï¼Œä½“éªŒä¸åˆ°é•¿åŸéå¥½æ±‰çš„è±ªæƒ…',
              images: ['https://picsum.photos/seed/greatwall1/300/200.jpg', 'https://picsum.photos/seed/greatwall2/300/200.jpg'],
              tips: 'å»ºè®®ç©¿èˆ’é€‚çš„è¿åŠ¨é‹ï¼Œå¸¦å¥½é˜²æ™’ç”¨å“'
            },
            {
              time: '14:00',
              title: 'æ˜åä¸‰é™µ',
              description: 'å‚è§‚å®šé™µï¼Œäº†è§£æ˜ä»£çš‡å®¶é™µå¯æ–‡åŒ–',
              images: ['https://picsum.photos/seed/mingtombs1/300/200.jpg'],
              tips: 'å®šé™µæ˜¯å”¯ä¸€å¼€æ”¾åœ°å®«çš„çš‡é™µï¼Œå€¼å¾—ä¸€çœ‹'
            }
          ]
        },
        {
          title: 'é¢å’Œå›­-åœ†æ˜å›­',
          description: 'æ¸¸è§ˆçš‡å®¶å›­æ—ï¼Œæ„Ÿå—å¤å…¸å›­æ—ä¹‹ç¾',
          places: ['é¢å’Œå›­', 'åœ†æ˜å›­'],
          activities: [
            {
              time: '09:00',
              title: 'é¢å’Œå›­',
              description: 'æ¸¸è§ˆæ˜†æ˜æ¹–ã€ä¸‡å¯¿å±±ã€é•¿å»Šç­‰æ™¯ç‚¹',
              images: ['https://picsum.photos/seed/yiheyuan1/300/200.jpg', 'https://picsum.photos/seed/yiheyuan2/300/200.jpg'],
              tips: 'å»ºè®®ä»ä¸œå®«é—¨è¿›å…¥ï¼Œæ¸¸è§ˆè·¯çº¿æ›´åˆç†'
            },
            {
              time: '14:00',
              title: 'åœ†æ˜å›­',
              description: 'å‚è§‚é—å€å…¬å›­ï¼Œäº†è§£å†å²',
              images: ['https://picsum.photos/seed/yuanmingyuan1/300/200.jpg'],
              tips: 'å¯ä»¥ç§Ÿå€Ÿè®²è§£å™¨ï¼Œäº†è§£é—å€å†å²'
            }
          ]
        }
      ],
      budget: {
        transportation: 300,
        accommodation: 600,
        food: 450,
        tickets: 280,
        total: 1630
      },
      notices: [
        'æ•…å®«ã€é•¿åŸç­‰çƒ­é—¨æ™¯ç‚¹å»ºè®®æå‰ç½‘ä¸Šé¢„çº¦é—¨ç¥¨',
        'åŒ—äº¬æ—©æ™šæ¸©å·®å¤§ï¼Œæ³¨æ„å¸¦å¥½åˆé€‚çš„è¡£ç‰©',
        'åœ°é“æ˜¯åŒ—äº¬æœ€ä¾¿æ·çš„äº¤é€šå·¥å…·ï¼Œå»ºè®®åŠç†äº¤é€šå¡',
        'æ—…æ¸¸æ—ºå­£äººæµé‡å¤§ï¼Œæ³¨æ„å®‰å…¨å¹¶ä¿ç®¡å¥½éšèº«ç‰©å“'
      ]
    }
  },
  
  onLoad(options: any) {
    this.guideId = options.id || 0;
    this.loadGuideDetail();
    this.checkFavoriteStatus();
  },
  
  onShow() {
    // é¡µé¢æ˜¾ç¤ºæ—¶æ£€æŸ¥æ”¶è—çŠ¶æ€
    this.checkFavoriteStatus();
  },
  
  onShareAppMessage() {
    return {
      title: this.guideData.title,
      path: `/pages/guide-detail/index?id=${this.guideId}`,
      imageUrl: this.guideData.coverImage
    };
  },
  
  methods: {
    /**
     * åŠ è½½æ”»ç•¥è¯¦æƒ…
     */
    async loadGuideDetail() {
      try {
        wx.showLoading({
          title: 'åŠ è½½ä¸­...'
        });
        
        // è¿™é‡Œå¯ä»¥è°ƒç”¨APIè·å–æ•°æ®
        // const res = await api.getGuideDetail(this.guideId);
        // this.guideData = res.data;
        
        wx.hideLoading();
      } catch (error) {
        wx.hideLoading();
        console.error('åŠ è½½æ”»ç•¥è¯¦æƒ…å¤±è´¥:', error);
        wx.showToast({
          title: 'åŠ è½½å¤±è´¥',
          icon: 'none'
        });
      }
    },
    
    /**
     * æ£€æŸ¥æ”¶è—çŠ¶æ€
     */
    checkFavoriteStatus() {
      // è¿™é‡Œå¯ä»¥è°ƒç”¨APIæ£€æŸ¥æ”¶è—çŠ¶æ€
      // const res = api.checkFavorite(this.guideId);
      // this.isFavorite = res.data.isFavorite;
    },
    
    /**
     * è¿”å›ä¸Šä¸€é¡µ
     */
    goBack() {
      wx.navigateBack();
    },
    
    /**
     * åˆ‡æ¢æ”¶è—çŠ¶æ€
     */
    async toggleFavorite() {
      try {
        if (this.isFavorite) {
          // å–æ¶ˆæ”¶è—
          // await api.cancelFavorite(this.guideId);
          wx.showToast({
            title: 'å·²å–æ¶ˆæ”¶è—',
            icon: 'success'
          });
        } else {
          // æ·»åŠ æ”¶è—
          // await api.addFavorite(this.guideId);
          wx.showToast({
            title: 'æ”¶è—æˆåŠŸ',
            icon: 'success'
          });
        }
        this.isFavorite = !this.isFavorite;
      } catch (error) {
        console.error('æ”¶è—æ“ä½œå¤±è´¥:', error);
        wx.showToast({
          title: 'æ“ä½œå¤±è´¥',
          icon: 'none'
        });
      }
    },
    
    /**
     * åˆ†äº«æ”»ç•¥
     */
    shareGuide() {
      // è¿™é‡Œå¯ä»¥è°ƒç”¨è‡ªå®šä¹‰åˆ†äº«åŠŸèƒ½
      wx.showShareMenu({
        withShareTicket: true
      });
    },
    
    /**
     * ç”Ÿæˆè®¡åˆ’
     */
    generatePlan() {
      wx.navigateTo({
        url: `/pages/plan/index?guideId=${this.guideId}`
      });
    },
    
    /**
     * å¼€å§‹å¯¼èˆª
     */
    startNavigation() {
      wx.navigateTo({
        url: `/pages/navigation/index?guideId=${this.guideId}`
      });
    },
    
    /**
     * æ»šåŠ¨äº‹ä»¶
     */
    onScroll(e: any) {
      this.scrollTop = e.detail.scrollTop;
    },
    
    /**
     * é¢„è§ˆå›¾ç‰‡
     */
    previewImage(images: string[], current: number) {
      wx.previewImage({
        urls: images,
        current: current
      });
    }
  }
});
</script>

<style lang="scss" src="@/assets/styles/index.scss" />

<style lang="scss">
.guide-detail-page {
  height: 100vh;
  display: flex;
  flex-direction: column;
  background-color: #f5f5f5;
}

.nav-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 88rpx;
  padding: 0 20rpx;
  background-color: #ffffff;
  border-bottom: 1rpx solid #eee;
  position: relative;
  z-index: 100;
  
  .nav-left, .nav-right {
    display: flex;
    align-items: center;
    width: 150rpx;
    
    .nav-icon {
      font-size: 36rpx;
      margin: 0 10rpx;
    }
  }
  
  .nav-left {
    justify-content: flex-start;
  }
  
  .nav-right {
    justify-content: flex-end;
  }
  
  .nav-title {
    font-size: 32rpx;
    font-weight: bold;
    color: #333;
  }
}

.content-container {
  flex: 1;
  height: 0;
}

.cover-container {
  position: relative;
  height: 400rpx;
  
  .cover-image {
    width: 100%;
    height: 100%;
  }
  
  .cover-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 40rpx 30rpx;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
    
    .cover-title {
      display: block;
      font-size: 36rpx;
      font-weight: bold;
      color: #ffffff;
      margin-bottom: 16rpx;
    }
    
    .cover-meta {
      display: flex;
      
      .cover-destination {
        font-size: 28rpx;
        color: #ffffff;
        margin-right: 20rpx;
      }
      
      .cover-days {
        font-size: 28rpx;
        color: #ffffff;
      }
    }
  }
}

.info-container {
  display: flex;
  flex-wrap: wrap;
  padding: 30rpx;
  background-color: #ffffff;
  margin-bottom: 20rpx;
  
  .info-item {
    width: 50%;
    margin-bottom: 20rpx;
    
    .info-label {
      font-size: 24rpx;
      color: #999;
      margin-right: 10rpx;
    }
    
    .info-value {
      font-size: 28rpx;
      color: #333;
    }
  }
}

.section-container {
  margin-bottom: 20rpx;
  background-color: #ffffff;
  
  .section-title {
    padding: 30rpx;
    font-size: 32rpx;
    font-weight: bold;
    color: #333;
    border-bottom: 1rpx solid #eee;
  }
}

.timeline-container {
  padding: 30rpx;
  
  .timeline-item {
    display: flex;
    margin-bottom: 40rpx;
    
    &:last-child {
      margin-bottom: 0;
    }
    
    .timeline-dot {
      width: 20rpx;
      height: 20rpx;
      margin-right: 20rpx;
      margin-top: 10rpx;
      border-radius: 50%;
      background-color: #007aff;
    }
    
    .timeline-content {
      flex: 1;
      
      .timeline-day {
        font-size: 28rpx;
        font-weight: bold;
        color: #007aff;
        margin-bottom: 8rpx;
      }
      
      .timeline-title {
        font-size: 30rpx;
        font-weight: bold;
        color: #333;
        margin-bottom: 8rpx;
      }
      
      .timeline-desc {
        font-size: 26rpx;
        color: #666;
        margin-bottom: 16rpx;
      }
      
      .timeline-places {
        display: flex;
        flex-wrap: wrap;
        
        .place-tag {
          padding: 6rpx 16rpx;
          margin-right: 16rpx;
          margin-bottom: 16rpx;
          font-size: 24rpx;
          color: #007aff;
          background-color: rgba(0, 122, 255, 0.1);
          border-radius: 20rpx;
        }
      }
    }
  }
}

.day-container {
  padding: 0 30rpx 30rpx;
  
  .day-header {
    padding: 20rpx 0;
    border-bottom: 1rpx dashed #eee;
    
    .day-title {
      font-size: 30rpx;
      font-weight: bold;
      color: #333;
    }
  }
  
  .activity-item {
    display: flex;
    padding: 20rpx 0;
    border-bottom: 1rpx solid #f5f5f5;
    
    &:last-child {
      border-bottom: none;
    }
    
    .activity-time {
      width: 100rpx;
      font-size: 24rpx;
      color: #999;
    }
    
    .activity-content {
      flex: 1;
      
      .activity-title {
        font-size: 28rpx;
        font-weight: bold;
        color: #333;
        margin-bottom: 8rpx;
      }
      
      .activity-desc {
        font-size: 26rpx;
        color: #666;
        margin-bottom: 16rpx;
      }
      
      .activity-images {
        display: flex;
        margin-bottom: 16rpx;
        
        .activity-image {
          width: 200rpx;
          height: 150rpx;
          margin-right: 16rpx;
          border-radius: 8rpx;
        }
      }
      
      .activity-tips {
        padding: 16rpx;
        background-color: #f8f8f8;
        border-radius: 8rpx;
        
        .tips-label {
          font-size: 24rpx;
          color: #ff9500;
        }
        
        .tips-content {
          font-size: 24rpx;
          color: #666;
        }
      }
    }
  }
}

.budget-container {
  padding: 30rpx;
  
  .budget-item {
    display: flex;
    justify-content: space-between;
    padding: 16rpx 0;
    border-bottom: 1rpx solid #f5f5f5;
    
    &.total {
      font-weight: bold;
      border-top: 1rpx solid #eee;
      margin-top: 16rpx;
      padding-top: 24rpx;
    }
    
    .budget-label {
      font-size: 28rpx;
      color: #333;
    }
    
    .budget-value {
      font-size: 28rpx;
      color: #333;
    }
    
    &.total .budget-value {
      color: #ff3b30;
    }
  }
}

.notice-container {
  padding: 30rpx;
  
  .notice-item {
    display: flex;
    align-items: flex-start;
    margin-bottom: 20rpx;
    
    &:last-child {
      margin-bottom: 0;
    }
    
    .notice-icon {
      margin-right: 16rpx;
      font-size: 28rpx;
    }
    
    .notice-text {
      flex: 1;
      font-size: 26rpx;
      color: #666;
      line-height: 1.6;
    }
  }
}

.bottom-placeholder {
  height: 120rpx;
}

.bottom-bar {
  display: flex;
  align-items: center;
  height: 100rpx;
  padding: 0 30rpx;
  background-color: #ffffff;
  border-top: 1rpx solid #eee;
  
  .action-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-right: 40rpx;
    
    .action-icon {
      font-size: 32rpx;
      margin-bottom: 4rpx;
    }
    
    .action-text {
      font-size: 20rpx;
      color: #666;
    }
  }
  
  .action-button {
    flex: 1;
    height: 70rpx;
    line-height: 70rpx;
    text-align: center;
    background-color: #007aff;
    border-radius: 35rpx;
    
    .button-text {
      font-size: 28rpx;
      color: #ffffff;
    }
  }
}
</style>