# 旅行攻略微信小程序项目开发规则

## 1. 项目概述

本项目是一个基于高德地图MCP API的旅行攻略微信小程序，采用前后端分离架构，前端使用微信小程序技术栈，后端基于腾讯云函数实现，通过MCP协议调用高德地图服务，结合千问大模型提供智能攻略生成能力。

## 2. 技术框架与语言

### 2.1 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| 微信小程序 | 原生框架 | 小程序基础框架 |
| Taro | 3.x | 跨平台开发框架，支持React语法 |
| React | 18.x | 前端UI框架 |
| TypeScript | 5.x | 类型检查，提高代码质量 |
| Redux | 4.x | 状态管理 |
| Taro UI | 3.x | UI组件库 |
| Tailwind CSS | 3.x | CSS框架，用于样式设计 |

### 2.2 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Node.js | 20.19 | 运行时环境 |
| Express | 4.x | Web框架 |
| TypeScript | 5.x | 类型检查，提高代码质量 |
| 腾讯云函数 | - | 无服务器架构 |
| 腾讯云API网关 | - | API入口和流量控制 |
| 腾讯云数据库 | - | 数据存储 |
| 腾讯云COS | - | 对象存储服务 |

### 2.3 第三方服务

| 服务 | 用途 |
|------|------|
| 高德地图MCP Server | 地图服务、路径规划、POI搜索等 |
| 千问大模型API | 自然语言处理，解析用户输入 |
| 微信开放平台 | 用户身份认证，微信登录 |

## 3. 代码风格与规范

### 3.1 命名规范

| 类型 | 命名规范 | 示例 |
|------|----------|------|
| 文件名 | kebab-case | travel-guide.ts |
| 组件名 | PascalCase | TravelGuide |
| 变量名 | camelCase | travelGuide |
| 常量名 | UPPER_SNAKE_CASE | API_BASE_URL |
| 类名 | PascalCase | TravelService |
| 函数名 | camelCase | getTravelGuide |
| 接口名 | PascalCase | ITravelGuide |
| CSS类名 | kebab-case | travel-guide-container |

### 3.2 代码风格

1. **TypeScript规范**：
   - 所有函数和变量必须有明确的类型定义
   - 使用接口定义复杂对象结构
   - 避免使用`any`类型，必要时使用`unknown`或具体类型

2. **代码格式化**：
   - 使用ESLint + Prettier进行代码格式化
   - 缩进使用2个空格
   - 字符串优先使用单引号
   - 行末不加分号

3. **注释规范**：
   - 函数和类必须有JSDoc注释，说明功能、参数和返回值
   - 复杂逻辑必须添加行内注释
   - 注释使用中文

4. **变量命名**：
   - 使用语义化的变量和函数名，避免缩写和拼音
   - 布尔值变量以`is`、`has`、`can`等前缀开头
   - 避免使用魔法数字，定义为常量

5. **异步处理**：
   - 使用async/await处理异步操作，避免回调地狱
   - 错误处理使用try/catch块
   - 并发操作使用Promise.all或Promise.allSettled

### 3.3 Git提交规范

使用Conventional Commits规范：

```
<type>[optional scope]: <description>

[optional body]

[optional footer(s)]
```

类型说明：
- feat: 新功能
- fix: 修复bug
- docs: 文档更新
- style: 代码格式调整
- refactor: 代码重构
- test: 测试相关
- chore: 构建过程或辅助工具的变动

## 4. NPM包管理

### 4.1 依赖管理

1. **生产依赖**：
   - 只添加必要的生产依赖
   - 定期检查和更新依赖版本
   - 使用`npm-check-updates`工具检查更新

2. **开发依赖**：
   - 代码检查工具：ESLint、Prettier
   - 测试工具：Jest
   - 构建工具：Webpack、Taro CLI

3. **版本锁定**：
   - 使用`package-lock.json`锁定依赖版本
   - 主要依赖使用精确版本号
   - 次要依赖使用范围版本号

### 4.2 包发布规范

1. **私有包**：
   - 使用`@travel-guide`命名空间
   - 在package.json中设置`"private": true`

2. **版本管理**：
   - 遵循语义化版本规范(SemVer)
   - 主版本号：不兼容的API修改
   - 次版本号：向下兼容的功能性新增
   - 修订号：向下兼容的问题修正

## 5. 项目目录结构

### 5.1 前端目录结构

```
frontend/
├── src/                    # 源代码目录
│   ├── components/         # 通用组件
│   │   ├── common/         # 公共组件
│   │   ├── map/            # 地图相关组件
│   │   └── travel/         # 旅行相关组件
│   ├── pages/              # 页面组件
│   │   ├── home/           # 首页
│   │   ├── search/         # 搜索页
│   │   ├── guide/          # 攻略页
│   │   └── profile/        # 个人中心
│   ├── utils/              # 工具函数
│   │   ├── request.ts      # 网络请求封装
│   │   ├── websocket.ts    # WebSocket客户端
│   │   └── storage.ts      # 本地存储封装
│   ├── services/           # API服务
│   │   ├── auth.ts         # 认证服务
│   │   ├── travel.ts       # 旅行相关API
│   │   └── map.ts          # 地图相关API
│   ├── store/              # Redux状态管理
│   │   ├── actions/        # Action定义
│   │   ├── reducers/        # Reducer定义
│   │   └── index.ts        # Store配置
│   ├── types/              # TypeScript类型定义
│   │   ├── api.ts          # API类型
│   │   ├── map.ts          # 地图类型
│   │   └── travel.ts       # 旅行类型
│   ├── assets/             # 静态资源
│   │   ├── images/         # 图片资源
│   │   └── styles/         # 样式文件
│   ├── app.config.ts       # 应用配置
│   └── app.ts              # 应用入口
├── config/                 # Taro配置
│   ├── index.js            # 默认配置
│   └── prod.js             # 生产环境配置
├── project.config.json     # 微信小程序配置
├── package.json
└── tsconfig.json
```

### 5.2 后端目录结构

```
backend/
├── src/                    # 源代码目录
│   ├── controllers/        # 控制器
│   │   ├── auth.ts         # 认证控制器
│   │   ├── travel.ts       # 旅行控制器
│   │   └── map.ts          # 地图控制器
│   ├── services/           # 业务逻辑服务
│   │   ├── auth.ts         # 认证服务
│   │   ├── travel.ts       # 旅行服务
│   │   ├── map.ts          # 地图服务
│   │   └── llm.ts          # 大模型服务
│   ├── models/             # 数据模型
│   │   ├── user.ts         # 用户模型
│   │   └── travel.ts       # 旅行模型
│   ├── middleware/         # 中间件
│   │   ├── auth.ts         # 认证中间件
│   │   ├── cors.ts         # 跨域中间件
│   │   └── error.ts        # 错误处理中间件
│   ├── utils/              # 工具函数
│   │   ├── logger.ts       # 日志工具
│   │   ├── response.ts     # 响应封装
│   │   └── validation.ts   # 数据验证
│   ├── config/             # 配置文件
│   │   ├── database.ts     # 数据库配置
│   │   ├── llm.ts          # 大模型配置
│   │   └── mcp.ts          # MCP配置
│   └── mcp/                # MCP Client相关
│       ├── client.ts       # MCP客户端
│       ├── tools.ts        # 工具调用封装
│       └── config.json     # MCP服务器配置
├── functions/              # 云函数入口
│   ├── api/                # API云函数
│   │   ├── auth/           # 认证相关API
│   │   ├── travel/         # 旅行相关API
│   │   └── map/            # 地图相关API
│   └── websocket/          # WebSocket云函数
│       ├── connect/        # 连接处理
│       └── message/        # 消息处理
├── package.json
├── serverless.yml          # 腾讯云函数配置
└── tsconfig.json
```

## 6. 项目规范

### 6.1 组件开发规范

1. **组件结构**：
   - 每个组件一个文件夹，包含index.tsx、styles.ts和types.ts
   - 使用函数组件和React Hooks
   - 组件props必须有明确的类型定义

2. **状态管理**：
   - 全局状态使用Redux管理
   - 组件内部状态使用useState
   - 复杂状态逻辑使用useReducer

3. **样式规范**：
   - 使用Tailwind CSS进行样式设计
   - 组件样式使用CSS Modules或styled-components
   - 响应式设计遵循移动优先原则

### 6.2 API开发规范

1. **RESTful API**：
   - 遵循RESTful设计原则
   - 使用HTTP动词表示操作：GET(查询)、POST(创建)、PUT(更新)、DELETE(删除)
   - 使用名词表示资源，避免动词

2. **响应格式**：
   - 统一响应格式：`{code, message, data, timestamp}`
   - 成功响应：`{code: 200, message: "success", data: {...}, timestamp: 1234567890}`
   - 错误响应：`{code: 4xx/5xx, message: "error description", data: null, timestamp: 1234567890}`

3. **错误处理**：
   - 使用中间件统一处理错误
   - 记录详细错误日志
   - 返回用户友好的错误信息

### 6.3 数据库规范

1. **表设计**：
   - 表名使用小写字母和下划线
   - 主键统一使用`id`
   - 时间字段使用`created_at`和`updated_at`
   - 软删除使用`deleted_at`

2. **字段设计**：
   - 字段名使用小写字母和下划线
   - 布尔字段以`is_`开头
   - 外键字段以`_id`结尾

3. **索引设计**：
   - 为常用查询字段创建索引
   - 复合索引遵循最左前缀原则
   - 避免过多索引影响写入性能

### 6.4 安全规范

1. **身份认证**：
   - 使用JWT进行身份认证
   - Token设置合理过期时间
   - 敏感操作需要二次验证

2. **数据验证**：
   - 所有输入数据必须验证
   - 使用参数化查询防止SQL注入
   - 对敏感数据进行加密存储

3. **权限控制**：
   - 基于角色的访问控制(RBAC)
   - 最小权限原则
   - API接口进行权限校验

## 7. AI助手任务执行规范

为确保开发过程的有序性和可控性，AI助手必须严格遵循以下任务执行规范：

### 7.1 任务范围控制

- **严格按照任务拆分执行**: 必须严格按照 `docs/task_breakdown.md` 中定义的任务范围执行，不得超出指定任务的边界。
- **单一任务原则**: 每次只执行一个明确指定的任务（如"任务 1.1"、"任务 1.2"等），完成后等待用户确认再进行下一步。
- **禁止自动扩展**: 不得基于技术架构文档或其他文档自行扩展任务范围，如果需要扩展需要通知用户确认。

### 7.2 任务指令格式

用户应使用以下格式明确指定任务：

- **明确任务编号**: "请执行任务 X.X：[任务名称]"
- **范围限制**: "只完成任务 X.X 中列出的具体任务，不要超出范围"
- **停止指令**: "完成后等待我确认再进行下一步"

### 7.3 执行验收标准

- **任务完成确认**: 每个任务完成后，必须对照 `task_breakdown.md` 中的验收标准进行自检。
- **范围边界检查**: 确保所有创建的文件和代码都在指定任务范围内。
- **等待用户确认**: 任务完成后使用 `finish` 工具总结完成情况，等待用户确认后再进行下一个任务。

### 7.4 异常处理

- **任务描述不清晰**: 如果任务描述不清晰，应先询问具体范围而不是自行决定。
- **依赖关系处理**: 如果当前任务依赖其他未完成的任务，应明确指出依赖关系并等待用户指示。
- **超出范围的代码**: 如果发现已创建超出任务范围的代码，应主动询问是否需要清理。

## 8. 高德地图MCP API使用规范

### 8.1 API调用规范

1. **错误处理**：
   - 所有MCP API调用必须有错误处理
   - 网络错误时提供友好的错误提示
   - 记录API调用日志便于排查问题

2. **数据缓存**：
   - 地理编码结果进行本地缓存
   - POI搜索结果进行短期缓存
   - 路径规划结果不缓存，确保实时性

3. **频率控制**：
   - 控制API调用频率，避免触发限制
   - 批量请求时进行分批处理
   - 实现请求队列和重试机制

### 8.2 数据处理规范

1. **坐标格式**：
   - 统一使用"经度,纬度"格式
   - 坐标精度保留6位小数
   - 坐标系统一使用高德地图坐标系

2. **数据转换**：
   - API返回数据转换为前端需要的格式
   - 统一处理空值和异常数据
   - 提供默认值确保UI正常显示

## 9. 性能优化规范

### 9.1 前端优化

1. **代码分包**：
   - 按页面分包加载，减少首屏加载时间
   - 公共组件提取为独立包
   - 第三方库按需引入

2. **图片优化**：
   - 压缩图片，使用WebP格式
   - 实现图片懒加载
   - 使用CDN加速图片加载

3. **缓存策略**：
   - 合理使用本地缓存
   - API响应数据进行适当缓存
   - 实现缓存更新机制

### 9.2 后端优化

1. **数据库优化**：
   - 合理设计索引，优化查询
   - 避免N+1查询问题
   - 使用连接池管理数据库连接

2. **API优化**：
   - 实现分页查询，避免一次性返回大量数据
   - 使用缓存减少数据库压力
   - 压缩响应数据减少传输量

## 10. 测试规范

### 10.1 测试策略

1. **单元测试**：
   - 工具函数必须有单元测试
   - 组件测试覆盖主要交互逻辑
   - API服务测试覆盖各种场景

2. **集成测试**：
   - 测试组件间交互
   - 测试API接口集成
   - 测试数据流完整性

3. **端到端测试**：
   - 测试核心业务流程
   - 测试用户主要使用场景
   - 测试异常情况处理

### 10.2 测试规范

1. **测试文件命名**：
   - 单元测试文件：`*.test.ts`
   - 集成测试文件：`*.integration.test.ts`
   - 端到端测试文件：`*.e2e.test.ts`

2. **测试覆盖率**：
   - 代码覆盖率不低于80%
   - 核心业务逻辑覆盖率不低于95%
   - 定期检查覆盖率报告

## 11. 部署与运维规范

### 11.1 部署流程

1. **前端部署**：
   - 使用Taro CLI构建小程序代码
   - 通过微信开发者工具上传代码
   - 在微信公众平台提交审核
   - 审核通过后发布上线

2. **后端部署**：
   - 使用Serverless Framework部署云函数
   - 配置API网关路由和触发器
   - 配置数据库和缓存
   - 配置环境变量和密钥

### 11.2 监控与告警

1. **监控指标**：
   - API响应时间
   - 错误率
   - 用户活跃度
   - 系统资源使用率

2. **告警机制**：
   - 关键指标异常实时告警
   - 多渠道通知：短信、邮件、微信
   - 告警升级机制

## 12. 文档规范

### 12.1 代码文档

1. **API文档**：
   - 使用Swagger/OpenAPI规范
   - 包含请求参数、响应格式、错误码
   - 提供示例代码

2. **组件文档**：
   - 组件功能说明
   - Props参数说明
   - 使用示例

### 12.2 项目文档

1. **README.md**：
   - 项目简介
   - 技术栈
   - 安装和运行指南
   - 贡献指南

2. **架构文档**：
   - 系统架构图
   - 数据流图
   - 技术选型说明

## 13. HTML文件预览规则

当创建HTML文件后，为了提供更好的开发体验和热更新功能，应该：

-  **使用npx live-server启动本地服务器**
   - 命令：`npx --yes live-server --port=3000 --host=localhost --no-browser 文件名.html`
   - 优势：无需安装依赖，支持热更新，配合Trae编辑器内置预览功能，避免打开外部浏览器
   - 适用场景：所有HTML文件的预览和开发
   - 重要：使用`--no-browser`参数禁止自动打开浏览器，`--yes`参数避免用户交互，实现完全自动化

-  **最佳实践**
   - 优先使用live-server，提供实时热更新功能
   - 端口统一使用3000，保持一致性
   - 确保用户体验简单，减少配置步骤
   - 在vibe coding项目中，让用户专注于效果预览，无需关心环境配置

## 14.在Windows PowerShell中执行命令，终端使用的是Windows PowerShell。

## 14. 总结

本规范文档旨在为旅行攻略微信小程序项目提供全面的开发指导，确保代码质量、项目可维护性和团队协作效率。所有开发人员应严格遵守本规范，如有需要改进的地方，可以通过团队讨论进行更新。

在开发过程中，应始终以用户体验为中心，注重代码质量和系统性能，确保项目能够长期稳定运行并持续迭代优化。